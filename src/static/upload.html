<!DOCTYPE html>
<html>
<head>
    <title>Fire Analysis Form</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        .indicator-img {
            width: 50px; /* Adjust as needed */
            height: 50px; /* Adjust as needed */
        }
    </style>
</head>
<body>
    <form id="fire-analysis-form">
        <label for="geojson">Zipped Shapefile:</label><br>
        <input type="file" id="shp_zip" name="shp_zip"><br>

        <label for="prefire">Prefire Date Range:</label><br>
        <input type="date" id="prefire-start" name="prefire-start">
        <input type="date" id="prefire-end" name="prefire-end"><br>
        <label for="postfire">Postfire Date Range:</label><br>
        <input type="date" id="postfire-start" name="postfire-start">
        <input type="date" id="postfire-end" name="postfire-end"><br>

        <label for="fire_event_name">Fire Event Name:</label><br>
        <input type="text" id="fire_event_name" name="fire_event_name"><br>
        <label for="affiliation">Affiliation:</label><br>
        <input type="text" id="affiliation" name="affiliation"><br>
        <input type="submit" value="Submit">
    </form>

    <div id="upload-loading" style="display: none;">
        <img class="indicator-img" src="/static/spinner.gif" alt="Uploading shapefile... this may take a few moments." />
        <p>Uploading shapefile... this may take a few moments.</p>
    </div>

    <div id="upload-success" style="display: none;">
        <img class="indicator-img" src="/static/checkmark.png" alt="Upload Success!" />
        <p>Upload Success!</p>
    </div>

    <div id="burn-analysis-loading" style="display: none;">
        <img class="indicator-img" src="/static/spinner.gif" alt="Analyzing burn area... depending on AOI size, this may take several minutes." />
        <p>Analyzing burn area... depending on AOI size, this may take several minutes.</p>
    </div>

    <div id="burn-analysis-success" style="display: none;">
        <img class="indicator-img" src="/static/checkmark.png" alt="Burn Metric Analysis Success!" />
        <p>Burn Metric Analysis Success!</p>
    </div>

    <div id="ecoclass-analysis-loading" style="display: none;">
        <img class="indicator-img" src="/static/spinner.gif" alt="Analyzing ecoclassification... depending on AOI size, this may take several minutes." />
        <p>Analyzing ecoclassification... depending on AOI size, this may take several minutes.</p>
    </div>

    <div id="ecoclass-analysis-success" style="display: none;">
        <img class="indicator-img" src="/static/checkmark.png" alt="EDIT Ecoclass Analysis Success!" />
        <p>EDIT Ecoclass Analysis Success!</p>
    </div>

    <script>
    $("#fire-analysis-form").on("submit", function(event) {
        event.preventDefault();

        // Show the upload loading spinner
        $("#upload-loading").show();
        $("#burn-analysis-loading").show();
        $("#ecoclass-analysis-loading").show();

        var formData = new FormData();
        formData.append('file', $('#shp_zip')[0].files[0]);
        formData.append('fire_event_name', $("#fire_event_name").val());
        formData.append('affiliation', $("#affiliation").val());

        // Make a request to upload the shapefile
        var upload = $.ajax({
            url: `/api/upload-shapefile-zip`,
            type: 'post',
            processData: false,
            contentType: false,
            data: formData,
            success: function() {
                $("#upload-loading").hide();
                $("#upload-success").show();
            },
            error: function() {
                $("#upload-loading").hide();
                alert("Upload failed");
            }
        });

        $.when(upload).done(function(uploadResponse) {
            // Log the data returned from the first AJAX call
            console.log('upload success', uploadResponse);

            // Make a request to analyze the burn
            $.ajax({
                url: '/api/query-satellite/analyze-burn',
                type: 'post',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify({
                    geojson: uploadResponse.geojson,
                    fire_event_name: $("#fire_event_name").val(),
                    affiliation: $("#affiliation").val(),
                    date_ranges: {
                        prefire: [$("#prefire-start").val(), $("#prefire-end").val()],
                        postfire: [$("#postfire-start").val(), $("#postfire-end").val()]
                    }
                }),
                success: function (analysisResponse) {
                    $("#burn-analysis-loading").hide();
                    $("#burn-analysis-success").show();
                },
                error: function (error) {
                    console.error(error);
                    $("#burn-analysis-loading").hide();
                    alert("Burn analysis failed")
                }
            });

            // Make a request to analyze the ecoclassification
            $.ajax({
                url: '/api/query-soil/analyze-ecoclass',
                type: 'post',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify({
                    geojson: uploadResponse.geojson,
                    fire_event_name: $("#fire_event_name").val(),
                    affiliation: $("#affiliation").val(),
                }),
                success: function () {
                    $("#ecoclass-analysis-loading").hide();
                    $("#ecoclass-analysis-success").show();
                },
                error: function () {
                    console.error(error);
                    $("#ecoclass-analysis-loading").hide();
                    alert("Ecoclass analysis failed");
                }
            });
        }).fail(function(error) {
            console.error(error);
        });
    });
    </script>
</body>
</html>