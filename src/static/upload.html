<!DOCTYPE html>
<html>
<head>
    <title>Fire Analysis Form</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <form id="fire-analysis-form">
        <label for="geojson">Zipped Shapefile:</label><br>
        <input type="file" id="shp_zip" name="shp_zip"><br>

        <label for="prefire">Prefire Date Range:</label><br>
        <input type="date" id="prefire-start" name="prefire-start">
        <input type="date" id="prefire-end" name="prefire-end"><br>
        <label for="postfire">Postfire Date Range:</label><br>
        <input type="date" id="postfire-start" name="postfire-start">
        <input type="date" id="postfire-end" name="postfire-end"><br>

        <label for="fire_event_name">Fire Event Name:</label><br>
        <input type="text" id="fire_event_name" name="fire_event_name"><br>
        <label for="affiliation">Affiliation:</label><br>
        <input type="text" id="affiliation" name="affiliation"><br>
        <input type="submit" value="Submit">
    </form>

    <div id="upload-loading" style="display: none;">
        <img src="spinner.gif" alt="Uploading shapefile... this may take a few moments." />
    </div>

    <div id="upload-success" style="display: none;">
        <img src="checkmark.png" alt="Upload Success!" />
    </div>

    <div id="analysis-loading" style="display: none;">
        <img src="spinner.gif" alt="Analyzing burn area... depending on AOI size, this may take several minutes." />
    </div>

    <div id="analysis-success" style="display: none;">
        <img src="checkmark.png" alt="Analysis Success!" />
    </div>

    <script>
    $("#fire-analysis-form").on("submit", function(event) {
        event.preventDefault();

        // Show the upload loading spinner
        $("#upload-loading").show();
        $("#analysis-loading").show();

        var formData = new FormData();
        formData.append('file', $('#shp_zip')[0].files[0]);
        formData.append('fire_event_name', $("#fire_event_name").val());
        formData.append('affiliation', $("#affiliation").val());

        // Make a request to upload the shapefile
        $.ajax({
            url: `/api/upload-shapefile-zip`,
            type: 'post',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                // Hide the upload loading spinner and show the upload success checkmark
                $("#upload-loading").hide();
                $("#upload-success").show();

                // Make a request to analyze the burn
                $.ajax({
                    url: '/api/analyze-burn',
                    type: 'post',
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (data) {
                        // Hide the analysis loading spinner and show the analysis success checkmark
                        $("#analysis-loading").hide();
                        $("#analysis-success").show();
                    },
                    error: function (error) {
                        // Handle error
                        console.error(error);
                    },
                    data: JSON.stringify({
                        fire_event_name: $("#fire_event_name").val(),
                        affiliation: $("#affiliation").val(),
                        date_ranges: {
                            prefire: [$("#prefire-start").val(), $("#prefire-end").val()],
                            postfire: [$("#postfire-start").val(), $("#postfire-end").val()]
                        }
                    })
                });
            },
            error: function (error) {
                // Handle error
                console.error(error);
            }
        });
    });
</script>
</body>
</html>