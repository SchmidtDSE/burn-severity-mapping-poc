<!DOCTYPE html>
<html>
<head>
    <title>Fire Analysis Form</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <style>
        .indicator-img {
            width: 50px; 
            height: 50px;
        }

        .container {
            display: flex;
            justify-content: space-between;
        }

        .upload-area {
            flex: 0 0 30%;
            border: 1px solid #ccc;
            padding: 10px;
            margin-right: 10px;
        }

        .map-area {
            flex: 0 0 70%;
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 500px; 
        }

        .form-area {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="upload-area">
            <label for="shp_zip">Zipped Shapefile:</label><br>
            <input type="file" id="shp_zip" name="shp_zip"><br>
        </div>
        <div id="map" class="map-area"></div>
    </div>

        <div class="form-area">
        <form id="fire-analysis-form">
            <label for="geojson">Zipped Shapefile:</label><br>
            <input type="file" id="shp_zip" name="shp_zip"><br>

            <label for="prefire">Prefire Date Range:</label><br>
            <input type="date" id="prefire-start" name="prefire-start">
            <input type="date" id="prefire-end" name="prefire-end"><br>
            <label for="postfire">Postfire Date Range:</label><br>
            <input type="date" id="postfire-start" name="postfire-start">
            <input type="date" id="postfire-end" name="postfire-end"><br>

            <label for="fire_event_name">Fire Event Name:</label><br>
            <input type="text" id="fire_event_name" name="fire_event_name"><br>
            <label for="affiliation">Affiliation:</label><br>
            <input type="text" id="affiliation" name="affiliation"><br>
            <input type="submit" value="Submit">
        </form>
    </div>
    
    <div id="upload-loading" style="display: none;">
        <img class="indicator-img" src="/static/upload/spinner.gif" alt="Uploading shapefile... this may take a few moments." />
        <p>Uploading shapefile... this may take a few moments.</p>
    </div>

    <div id="upload-success" style="display: none;">
        <img class="indicator-img" src="/static/upload/checkmark.png" alt="Upload Success!" />
        <p>Upload Success!</p>
    </div>

    <div id="burn-analysis-loading" style="display: none;">
        <img class="indicator-img" src="/static/upload/spinner.gif" alt="Analyzing burn area... depending on AOI size, this may take several minutes." />
        <p>Analyzing burn area... depending on AOI size, this may take several minutes.</p>
    </div>

    <div id="burn-analysis-success" style="display: none;">
        <img class="indicator-img" src="/static/upload/checkmark.png" alt="Burn Metric Analysis Success!" />
        <p>Burn Metric Analysis Success!</p>
    </div>

    <div id="ecoclass-analysis-loading" style="display: none;">
        <img class="indicator-img" src="/static/upload/spinner.gif" alt="Analyzing ecoclassification... depending on AOI size, this may take several minutes." />
        <p>Analyzing ecoclassification... depending on AOI size, this may take several minutes.</p>
    </div>

    <div id="ecoclass-analysis-success" style="display: none;">
        <img class="indicator-img" src="/static/upload/checkmark.png" alt="EDIT Ecoclass Analysis Success!" />
        <p>EDIT Ecoclass Analysis Success!</p>
    </div>

    <script>

        // AOI Input Map
        var map = L.map('map').setView([51.505, -0.09], 13);

        // Add a tile layer to the map
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        // Initialize the FeatureGroup to store editable layers
        var editableLayers = new L.FeatureGroup();
        map.addLayer(editableLayers);

        // Initialize the draw control and pass it the FeatureGroup of editable layers
        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: editableLayers
            }
        });
        map.addControl(drawControl);

        // When a shape is drawn, disable the file input
        map.on('draw:created', function (e) {
            var type = e.layerType,
                layer = e.layer;

            // Add the drawn layer to the editable layers
            editableLayers.addLayer(layer);

            // Disable the file input
            $('#shp_zip').prop('disabled', true);
        });

        // When a file is selected, disable the draw control
        $('#shp_zip').change(function() {
            if (this.files.length > 0) {
                map.removeControl(drawControl);
            }
        });

        $("#fire-analysis-form").on("submit", function(event) {
            event.preventDefault();

            // Show the upload loading spinner
            $("#upload-loading").show();
            $("#burn-analysis-loading").show();
            $("#ecoclass-analysis-loading").show();

            var formData = new FormData();
            formData.append('file', $('#shp_zip')[0].files[0]);
            formData.append('fire_event_name', $("#fire_event_name").val());
            formData.append('affiliation', $("#affiliation").val());


            if ($('#shp_zip').prop('disabled')) {
                // Get the drawn shape
                var drawnGeojson = editableLayers.toGeoJSON();
                formData.append('geojson', JSON.stringify(drawnGeojson));

                // Make a request to upload the drawn shape
                var upload = $.ajax({
                    url: `/api/upload-drawn-aoi`,
                    type: 'post',
                    processData: false,
                    contentType: false,
                    data: formData,
                    success: function() {
                        $("#upload-loading").hide();
                        $("#upload-success").show();
                    },
                    error: function() {
                        $("#upload-loading").hide();
                        alert("Upload failed");
                    }
                });

            } else if ($('#shp_zip')[0].files.length > 0) {

                // Add the shapefile to the form data
                formData.append('shapefile', $('#shp_zip')[0].files[0]);

                // Make a request to upload the shapefile
                var upload = $.ajax({
                    url: `/api/upload-shapefile-zip`,
                    type: 'post',
                    processData: false,
                    contentType: false,
                    data: formData,
                    success: function() {
                        $("#upload-loading").hide();
                        $("#upload-success").show();
                    },
                    error: function() {
                        $("#upload-loading").hide();
                        alert("Upload failed");
                    }
                });
            } 

            $.when(upload).done(function(uploadResponse) {
                // Log the data returned from the first AJAX call
                console.log('upload success', uploadResponse);

                // Make a request to analyze the burn
                $.ajax({
                    url: '/api/query-satellite/analyze-burn',
                    type: 'post',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        geojson: uploadResponse.geojson,
                        fire_event_name: $("#fire_event_name").val(),
                        affiliation: $("#affiliation").val(),
                        date_ranges: {
                            prefire: [$("#prefire-start").val(), $("#prefire-end").val()],
                            postfire: [$("#postfire-start").val(), $("#postfire-end").val()]
                        }
                    }),
                    success: function (analysisResponse) {
                        $("#burn-analysis-loading").hide();
                        $("#burn-analysis-success").show();
                    },
                    error: function (error) {
                        console.error(error);
                        $("#burn-analysis-loading").hide();
                        alert("Burn analysis failed")
                    }
                });

                // Make a request to analyze the ecoclassification
                $.ajax({
                    url: '/api/query-soil/analyze-ecoclass',
                    type: 'post',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        geojson: uploadResponse.geojson,
                        fire_event_name: $("#fire_event_name").val(),
                        affiliation: $("#affiliation").val(),
                    }),
                    success: function () {
                        $("#ecoclass-analysis-loading").hide();
                        $("#ecoclass-analysis-success").show();
                    },
                    error: function () {
                        console.error(error);
                        $("#ecoclass-analysis-loading").hide();
                        alert("Ecoclass analysis failed");
                    }
                });
            }).fail(function(error) {
                console.error(error);
            });
        });
    </script>
</body>
</html>